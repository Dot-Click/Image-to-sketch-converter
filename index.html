<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image to SVG Converter</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css"
      integrity="sha512-jnSuA4Ss2PkkikSOLtYs8BlYIeeIK1h99ty4YfvRPAlzr377vr3CXDb7sb7eEEBYjDtcYj+AjBH3FLv5uSJuXg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <style>
      span.help {
        font-size: 13px;
        color: #ffffff;
        background: #21201f;
        width: 20px;
        height: 20px;
        display: inline-block;
        text-align: center;
        border-radius: 28px;
        cursor: pointer;
      }
      .outputImage {
        width: 300px;
        height: 300px;
      }
      #imageForm {
        width: 100%;
        max-width: 500px;
        margin: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: fit-content;
        border: 1px solid #a1a1a1;
        padding: 20px;
      }
      body {
        min-height: 100vh;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
      }
      p#message {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        margin: auto;
        border: 1px solid #d3cccc;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <form id="imageForm">
      <h2>Convert Image to SVG Outline</h2>
      <div class="form-group w-100">
        <label for="image">Select an image:</label>
        <input
          type="file"
          id="image"
          name="image"
          accept="image/*"
          required
          class="form-control"
        />
      </div>
      <br />
      <div class="form-group w-100">
        <label class="form-label" for="blur">
          Blur Value:
          <span class="help" data-toggle="modal" data-target="#exampleModal">
            ?
          </span>
        </label>
        <input
          class="form-range"
          type="range"
          id="blur"
          name="blur"
          value="5"
          min="1"
          max="21"
          step="2"
          oninput="this.nextElementSibling.value = this.value"
        />
        <output>5</output>
      </div>
      <br />
      <div class="form-group w-100">
        <label class="form-label" for="canny_thresh1"
          >Canny Threshold 1:
          <span class="help" data-toggle="modal" data-target="#exampleModal"
            >?</span
          ></label
        >
        <input
          type="range"
          id="canny_thresh1"
          name="canny_thresh1"
          value="50"
          class="form-range"
          oninput="this.nextElementSibling.value = this.value"
        />
        <output>50</output>
      </div>
      <br />
      <div class="form-group w-100">
        <label class="form-label" for="canny_thresh2"
          >Canny Threshold 2:
          <span class="help" data-toggle="modal" data-target="#exampleModal"
            >?</span
          ></label
        >
        <input
          type="range"
          id="canny_thresh2"
          name="canny_thresh2"
          value="60"
          class="form-range"
          oninput="this.nextElementSibling.value = this.value"
        />
        <output>60</output>
      </div>
      <br />

      <button type="submit" id="submitbutton" class="btn btn-success">
        Convert Image
      </button>
    </form>

    <p id="message"></p>
    <div
      class="modal fade"
      id="exampleModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-body">
            <div>
              <h4>Blur Value</h4>
              <p>
                This setting controls how much the image is blurred to smooth
                out noise before detecting edges. It helps in making sure that
                noise doesn't get mistaken for edges. The blur value should be
                an odd number like 3, 5, or 7, which determines the size of the
                blur effect applied to the image.
              </p>
            </div>
            <div>
              <h4>Canny Threshold 2</h4>
              <p>
                This is the upper limit for detecting strong edges in the image.
                If a pixel's edge strength is higher than this value, it is
                definitely considered an edge. This threshold works together
                with another lower threshold to help find both strong and weak
                edges. The combination of these thresholds makes the edge
                detection more accurate.
              </p>
            </div>
            <div>
              <h4>Canny Threshold 1</h4>
              <p>
                This is the lower limit for detecting edges in the image. Pixels
                with edge strength above this value are marked as edges. It
                helps in finding weaker edges that might be missed by the higher
                threshold alone.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
      integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.min.js"
      integrity="sha512-ykZ1QQr0Jy/4ZkvKuqWn4iF3lqPZyij9iRv6sGqLRdTPkY69YX6+7wvVGmsdBbiIfN/8OdsI7HABjvEok6ZopQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script>
      jQuery(document).on("click", ".help", function () {
        jQuery("#exampleModal").modal("show");
      });
      document
        .getElementById("imageForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault(); // Prevent default form submission
          document.getElementById("submitbutton").innerHTML = "Loading...";
          // Get the form data
          const formData = new FormData();
          const imageFile = document.getElementById("image").files[0];
          const blurValue = document.getElementById("blur").value;
          const cannyThresh1 = document.getElementById("canny_thresh1").value;
          const cannyThresh2 = document.getElementById("canny_thresh2").value;

          // Append the form data
          formData.append("image", imageFile);
          formData.append("blur", blurValue);
          formData.append("canny_thresh1", cannyThresh1);
          formData.append("canny_thresh2", cannyThresh2);

          try {
            // Send the POST request to the Flask API
            let api_path = "https://image-to-sketch-converter.vercel.app/convert"
            // let api_path = "http://localhost:5000/convert"
            const response = await fetch(api_path, {
              method: "POST",
              body: formData,
            });

            const result = await response.json();

            if (response.ok) {
              document.getElementById("submitbutton").innerHTML =
                "Convert Image";
              document.getElementById("message").innerHTML = `
                    Image converted successfully. <br>
                        <img src="${result.output_svg}" class="outputImage" />
                    <a class="btn btn-info" target="_blank" href="${result.output_svg}" download>Download SVG</a>
                `;
            } else {
              document.getElementById("submitbutton").innerHTML = "Try Again!";
              document.getElementById(
                "message"
              ).innerHTML = `Error: ${result.error}`;
            }
          } catch (error) {
            document.getElementById("submitbutton").innerHTML = "Try Again!";
            console.error("Error uploading image:", error);
            document.getElementById("message").innerHTML = "An error occurred.";
          }
        });
    </script>
  </body>
</html>
